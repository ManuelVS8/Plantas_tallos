<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>Las plantas y el tallo</title>
    <link rel="icon" type="image/x-icon" href="https://raw.githubusercontent.com/ManuelVS8/Audios-juegos-SCIENCE/refs/heads/main/icono.ico">
    <style>
        /* ====== Reset & base ====== */
        * { box-sizing: border-box; margin:0; padding:0; }
        :root{
            --blue:#001DFF;
            --blue-dark:#04032B;
            --blue-700:#1a3a5f;
            --blue-600:#254fba;
            --orange:#f59e42;
            --orange-700:#e67e22;
            --bg-grad-1:#1a3a5f;
            --bg-grad-2:#0d2340;
            --white:#ffffff;
            --green:#2ecc71;
            --red:#e74c3c;
            --panel:#E8EAFF;
            --tree-color:#f59e42; /* Naranja */
            --shrub-color:#e74c3c; /* Rojo */
            --herb-color:#2ecc71; /* Verde */
        }
        body{
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-grad-1) 0%, var(--bg-grad-2) 100%);
            min-height:100vh; 
            display:flex; 
            justify-content:center; 
            align-items: flex-start; 
            color:#333; 
            padding: 40px 10px 20px 10px; 
        }
        .game-container{
            background:var(--white); border-radius:16px; box-shadow:0 12px 24px rgba(0,0,0,.12);
            padding:1.2rem; max-width:980px; width:100%; min-height:640px; position:relative; overflow:hidden;
            display:flex; flex-direction:column;
        }
        header{ text-align:center; margin-bottom:.8rem; margin-top:1rem; }
        h1{ color:var(--blue-dark); font-size:clamp(2.5rem,6vw,3.5rem); font-weight:900; letter-spacing:.5px; margin-bottom: 0.5rem; }
        .subtitle{ color:var(--blue-700); font-size:clamp(1.1rem,3.5vw,1.4rem); margin-top:.25rem; font-weight: 600; }
        .highlight-keyword{ color:var(--orange); font-weight:800; }
        .highlight-tree{ color:var(--tree-color); font-weight:800; }
        .highlight-shrub{ color:var(--shrub-color); font-weight:800; }
        .highlight-herb{ color:var(--herb-color); font-weight:800; }

        /* Buttons */
        .btn{ color:#fff; border:none; padding:.75rem 1.2rem; border-radius:10px; cursor:pointer; font-weight:800;
            transition:transform .08s ease, box-shadow .2s ease, background-color .25s ease; min-width:180px; height:54px;
            display:inline-flex; align-items:center; justify-content:center; font-size: 1.2rem; margin-top: 1rem; z-index: 5; }
        .btn:hover{ transform:translateY(-2px); box-shadow:0 6px 14px rgba(0,0,0,.12); }
        .btn:active{ transform:translateY(0); }
        .btn-primary{ background:var(--orange); }
        .btn-primary:hover{ background:var(--orange-700); color:#fff; }

        .screen{ display:none; animation:fadeIn .35s ease; flex-direction: column; flex:1;}
        .screen.active{ display:flex; }
        @keyframes fadeIn{ from{opacity:0; transform:translateY(12px);} to{opacity:1; transform:translateY(0);} }

        .game-info{ display:flex; gap:.6rem; align-items:center; justify-content:space-between; margin:.4rem 0 1rem; flex-wrap:wrap; }
        .timer{ font-weight:900; color:var(--blue-700); font-size:clamp(.95rem,2.3vw,1.15rem); }
        .level-indicator{ font-weight:900; color:var(--blue-700); font-size:clamp(.95rem,2.3vw,1.15rem); }
        .progress-bar{ flex:1; height:10px; background:#e6f2ff; border-radius:999px; overflow:hidden; }
        .progress-fill{ height:100%; width:0%; background:linear-gradient(90deg, var(--orange) 0%, var(--orange-700) 100%); transition:width .3s ease; }

        /* Pantalla de Inicio */
        .start-content{ display:flex; flex-direction:column; align-items:center; flex:1; padding:1rem; text-align: center; }
        .advice-box{ background:var(--panel); border-left:4px solid var(--blue-700); padding:1.2rem; border-radius:12px;
            color:var(--blue-700); max-width:760px; font-size:clamp(1rem,3vw,1.2rem); line-height: 1.6; margin-bottom: 1rem; }
        .advice-anim-text { display: block; text-align: center; font-weight: 900; margin-top: 1rem; font-size: 1.4rem; }
        
        .start-image-container { width: 100%; display: flex; justify-content: center; margin-top: auto; padding-top: 1rem; }
        .start-image{ max-width: 400px; width: 100%; height: auto; display: block; }
        
        .mute-btn{ position:absolute; top:.8rem; right:1rem; background:var(--orange); color:#fff; border:2px solid #fff; width:38px; height:38px; border-radius:50%; cursor:pointer; font-size:1rem; display:flex; align-items:center; justify-content:center; z-index:20; }

        /* Panel de Juego General */
        .board{ display:flex; flex-direction:column; gap:1rem; align-items:center; flex:1; width:100%; }
        
        /* Juego 1 y 3 (Im√°genes) */
        .stage{ background:#fff; border-radius:12px; border:2px solid #e6f2ff; padding:.6rem; position: relative; width:100%; max-width:600px; display:flex; flex-direction:column; align-items:center;}
        .img-wrap{ position:relative; width:100%; max-width:500px; margin:0 auto; }
        .img-wrap img{ display:block; width:100%; height:auto; border-radius:10px; user-select:none; }

        /* Juego 2 (Tarjetas) */
        .card-container{ width:100%; max-width:600px; background:#f8fbff; border:2px solid #d3e2ff; border-radius:12px; padding:1.5rem; display:flex; flex-direction:column; align-items:center; gap:1rem; min-height: 200px; justify-content: center;}
        .card-text{ font-size:clamp(1.2rem, 4vw, 1.6rem); font-weight:700; color:var(--blue-dark); text-align:center; line-height: 1.4; }
        .btn-play-card{ background:var(--blue-600); color:#fff; border:none; border-radius:50%; width:48px; height:48px; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:background-color .2s; flex-shrink: 0; }
        .btn-play-card svg{ width:26px; height:26px; }

        /* Botones de Respuesta (Grid) */
        .answers-grid{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:0.8rem; width:100%; max-width:600px; margin-top:auto; padding-bottom: 1rem; }
        .btn-answer{ 
            color:#fff; border:none; padding:1rem; border-radius:10px; cursor:pointer; font-weight:800; font-size: clamp(1rem, 3vw, 1.2rem); 
            transition: transform .1s, filter .1s; display:flex; align-items:center; justify-content:center; min-height: 60px;
        }
        .btn-answer:active{ transform: scale(0.95); }
        .btn-answer.highlight-correct{ filter: brightness(1.2); transform: scale(1.05); box-shadow: 0 0 15px rgba(255,255,255,0.5); pointer-events: none; }
        .btn-answer.highlight-wrong{ filter: brightness(0.8); transform: scale(0.95); pointer-events: none; }
        
        .btn-tree{ background: var(--tree-color); }
        .btn-shrub{ background: var(--shrub-color); }
        .btn-herb{ background: var(--herb-color); }

        /* Pantalla Final */
        .results{ display:flex; flex-direction:column; align-items:center; gap:.6rem; text-align:center; flex:1; justify-content:center;}
        .final-title{ color:var(--blue-dark); font-weight:900; }
        .big-score{ font-size:clamp(2.2rem,6vw,3.4rem); color:var(--blue-600); font-weight:900; }
        #trophyBox { display: none; font-size: 5rem; animation: bounce 1s ease infinite; }
        @keyframes bounce { 0%,100%{ transform: translateY(0); } 50%{ transform: translateY(-15px); } }
        
        .school-logo { display: block; width: 160px; margin-top: 0.8rem; }
        
        /* Animaciones */
        .shake { animation: shakeAnim 0.3s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shakeAnim {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        /* Confeti */
        .confetti{ 
            position:fixed; 
            width:10px; 
            height:10px; 
            border-radius:50%; 
            animation: confetti-fall 3s linear forwards; 
            z-index:999; 
            pointer-events: none; 
        }
        @keyframes confetti-fall{ 
            0%{ transform:translate(0, -20px) rotate(0); opacity:1;} 
            100%{ transform:translate(var(--tx), var(--ty)) rotate(360deg); opacity:0; } 
        }

        @media (max-width:600px){ 
            .answers-grid{ gap:0.5rem; }
            .btn-answer{ font-size: 0.9rem; padding: 0.8rem; min-height: 50px; }
        }
    </style>
</head>
<body>
<div class="game-container" id="mainContainer">
    <button class="mute-btn" id="muteBtn">üîä</button>

    <!-- Pantalla de Inicio -->
    <section class="screen active" id="startScreen">
        <header>
            <h1>Las plantas y el tallo</h1>
            <div class="subtitle">Clasifica las plantas seg√∫n las caracter√≠sticas de su tallo.</div>
        </header>
        
        <div class="start-content">
            <div class="advice-box">
                En este juego aprender√°s a diferenciar los diferentes tipos de plantas seg√∫n su tallo: <span class="highlight-keyword">√°rboles, arbustos y hierbas</span>.
                <span class="advice-anim-text">¬°√Ånimo!</span>
            </div>

            <div class="start-image-container">
                <img class="start-image" src="https://raw.githubusercontent.com/ManuelVS8/Efectos_audio/refs/heads/main/Ni%C3%B1os.png" alt="Imagen Ni√±os">
            </div>

            <button class="btn btn-primary" id="playBtn">Comenzar</button>
        </div>
    </section>

    <!-- Pantalla de Juego 1: Se√±alar -->
    <section class="screen" id="game1Screen">
        <header><h1>Las plantas y el tallo</h1></header>
        <div class="subtitle" style="text-align:center;">Indica si las siguientes plantas son <span class="highlight-tree">√°rboles</span>, <span class="highlight-shrub">arbustos</span> o <span class="highlight-herb">hierbas</span>.</div>
        
        <div class="game-info">
            <div class="level-indicator" id="level1">Nivel 1/9</div>
            <div class="progress-bar"><div class="progress-fill" id="progressFill1"></div></div>
            <div class="timer" id="globalTimer">00:00.0</div>
        </div>

        <div class="board">
            <div class="stage">
                <div class="img-wrap"><img id="gameImg1" src=""></div>
            </div>
            <div class="answers-grid">
                <button class="btn-answer btn-tree" data-type="√Årbol">üå≤ √Årbol</button>
                <button class="btn-answer btn-shrub" data-type="Arbusto">üåø Arbusto</button>
                <button class="btn-answer btn-herb" data-type="Hierba">üå± Hierba</button>
            </div>
        </div>
    </section>

    <!-- Pantalla de Juego 2: Preguntas -->
    <section class="screen" id="game2Screen">
        <header><h1>√Årboles, arbustos y hierbas</h1></header>
        <div class="subtitle" style="text-align:center;">Indica a qu√© tipo de planta se refieren las siguientes definiciones.</div>
        
        <div class="game-info">
            <div class="level-indicator" id="level2">Nivel 1/9</div>
            <div class="progress-bar"><div class="progress-fill" id="progressFill2"></div></div>
            <div class="timer" id="globalTimer2">00:00.0</div>
        </div>

        <div class="board">
            <div class="card-container" id="cardContainer2">
                <div class="card-text" id="cardText2">‚Äî</div>
                <button class="btn-play-card" id="playCardBtn2">
                    <svg viewBox="0 0 24 24" fill="none"><path d="M8 5v14l11-7z" fill="currentColor"/></svg>
                </button>
            </div>
            <div class="answers-grid" id="answers2">
                <button class="btn-answer btn-tree" data-type="√Årbol">üå≤ √Årbol</button>
                <button class="btn-answer btn-shrub" data-type="Arbusto">üåø Arbusto</button>
                <button class="btn-answer btn-herb" data-type="Hierba">üå± Hierba</button>
            </div>
        </div>
    </section>

    <!-- Pantalla de Juego 3: Paisajes -->
    <section class="screen" id="game3Screen">
        <header><h1>Los paisajes</h1></header>
        <div class="subtitle" style="text-align:center;">Indica si estas im√°genes son <span class="highlight-tree">arboledas</span>, <span class="highlight-shrub">matorrales</span> o <span class="highlight-herb">praderas</span>.</div>
        
        <div class="game-info">
            <div class="level-indicator" id="level3">Nivel 1/9</div>
            <div class="progress-bar"><div class="progress-fill" id="progressFill3"></div></div>
            <div class="timer" id="globalTimer3">00:00.0</div>
        </div>

        <div class="board">
            <div class="stage">
                <div class="img-wrap"><img id="gameImg3" src=""></div>
            </div>
            <div class="answers-grid" id="answers3">
                <button class="btn-answer btn-tree" data-type="Arboleda">üå≤ Arboleda</button>
                <button class="btn-answer btn-shrub" data-type="Matorral">üåø Matorral</button>
                <button class="btn-answer btn-herb" data-type="Pradera">üå± Pradera</button>
            </div>
        </div>
    </section>

    <!-- Pantalla Final -->
    <section class="screen" id="finalScreen">
        <header><h1 class="final-title">Las plantas y el tallo</h1></header>
        <div class="results">
            <div id="trophyBox">üèÜ</div>
            <div class="score-title">Puntuaci√≥n:</div>
            <div class="big-score" id="finalScore">0</div>
            <div class="final-time">Tiempo: <span id="finalTime">00:00.0</span></div>
            <div id="finalMsg" class="subtitle"></div>
            <button class="btn btn-primary" id="backToMenuBtn" style="background:var(--orange);">Volver al men√∫</button>
            <span class="credit">Creado por Manuel J. Ventura</span>
            <img class="school-logo" src="https://raw.githubusercontent.com/ManuelVS8/Efectos_audio/refs/heads/main/Siurot.png">
        </div>
    </section>
</div>

<script>
    // Variables Globales
    let isMuted = false, audioUnlocked = false, startTime = 0, timerInterval = null, elapsed = 0;
    let currentAudio = null, audioTimeout = null;
    
    // Contadores de aciertos
    let hits1 = 0, hits2 = 0, hits3 = 0;
    let idx1 = 0, idx2 = 0, idx3 = 0;
    let q1 = [], q2 = [], q3 = [];

    // Objetos de Audio
    const audioObjs = {
        correct: new Audio('https://raw.githubusercontent.com/ManuelVS8/Efectos_audio/refs/heads/main/Correcto.mp3'),
        error: new Audio('https://raw.githubusercontent.com/ManuelVS8/Efectos_audio/refs/heads/main/Error.mp3'),
        tap: new Audio('https://raw.githubusercontent.com/ManuelVS8/Efectos_audio/refs/heads/main/Tap.mp3'),
        victory: new Audio('https://raw.githubusercontent.com/ManuelVS8/Efectos_audio/refs/heads/main/Termin%C3%A9.mp3'),
        completed: new Audio('https://raw.githubusercontent.com/ManuelVS8/Efectos_audio/refs/heads/main/Completado.mp3')
    };

    // --- DATOS DEL JUEGO ---

    // Juego 1: Im√°genes Plantas
    const game1Data = [
        { type: '√Årbol', img: 'https://raw.githubusercontent.com/ManuelVS8/Audios-juegos-SCIENCE/refs/heads/main/Planta1/Planta2/arbol1.png' },
        { type: '√Årbol', img: 'https://raw.githubusercontent.com/ManuelVS8/Audios-juegos-SCIENCE/refs/heads/main/Planta1/Planta2/arbol2.png' },
        { type: '√Årbol', img: 'https://raw.githubusercontent.com/ManuelVS8/Audios-juegos-SCIENCE/refs/heads/main/Planta1/Planta2/arbol3.png' },
        { type: 'Arbusto', img: 'https://raw.githubusercontent.com/ManuelVS8/Audios-juegos-SCIENCE/refs/heads/main/Planta1/Planta2/arbusto1.png' },
        { type: 'Arbusto', img: 'https://raw.githubusercontent.com/ManuelVS8/Audios-juegos-SCIENCE/refs/heads/main/Planta1/Planta2/arbusto2.png' },
        { type: 'Arbusto', img: 'https://raw.githubusercontent.com/ManuelVS8/Audios-juegos-SCIENCE/refs/heads/main/Planta1/Planta2/arbusto3.png' },
        { type: 'Hierba', img: 'https://raw.githubusercontent.com/ManuelVS8/Audios-juegos-SCIENCE/refs/heads/main/Planta1/Planta2/hierba1.png' },
        { type: 'Hierba', img: 'https://raw.githubusercontent.com/ManuelVS8/Audios-juegos-SCIENCE/refs/heads/main/Planta1/Planta2/hierba2.png' },
        { type: 'Hierba', img: 'https://raw.githubusercontent.com/ManuelVS8/Audios-juegos-SCIENCE/refs/heads/main/Planta1/Planta2/hierba3.png' }
    ];

    // Juego 2: Definiciones
    const game2Data = [
        { type: '√Årbol', text: 'Tienen tallo duro y grueso. Sus ramas salen de un tronco.', audio: 'https://raw.githubusercontent.com/ManuelVS8/Audios-juegos-SCIENCE//refs/heads/main/Planta1/Planta2/arbol_tallo.mp3' },
        { type: 'Arbusto', text: 'Su tallo es delgado y duro. Sus ramas nacen cerca del suelo', audio: 'https://raw.githubusercontent.com/ManuelVS8/Audios-juegos-SCIENCE//refs/heads/main/Planta1/Planta2/Arbusto_tallo.mp3' },
        { type: 'Hierba', text: 'Tienen tallo fino y flexible.', audio: 'https://raw.githubusercontent.com/ManuelVS8/Audios-juegos-SCIENCE//refs/heads/main/Planta1/Planta2/Hierba_tallo.mp3' }
    ];

    // Juego 3: Paisajes
    const game3Data = [
        { type: 'Arboleda', img: 'https://raw.githubusercontent.com/ManuelVS8/Audios-juegos-SCIENCE/refs/heads/main/Planta1/Planta2/arboleda1.png' },
        { type: 'Arboleda', img: 'https://raw.githubusercontent.com/ManuelVS8/Audios-juegos-SCIENCE/refs/heads/main/Planta1/Planta2/arboleda2.png' },
        { type: 'Arboleda', img: 'https://raw.githubusercontent.com/ManuelVS8/Audios-juegos-SCIENCE/refs/heads/main/Planta1/Planta2/arboleda3.png' },
        { type: 'Matorral', img: 'https://raw.githubusercontent.com/ManuelVS8/Audios-juegos-SCIENCE/refs/heads/main/Planta1/Planta2/matorral1.png' },
        { type: 'Matorral', img: 'https://raw.githubusercontent.com/ManuelVS8/Audios-juegos-SCIENCE/refs/heads/main/Planta1/Planta2/matorral2.png' },
        { type: 'Matorral', img: 'https://raw.githubusercontent.com/ManuelVS8/Audios-juegos-SCIENCE/refs/heads/main/Planta1/Planta2/matorral3.png' },
        { type: 'Pradera', img: 'https://raw.githubusercontent.com/ManuelVS8/Audios-juegos-SCIENCE/refs/heads/main/Planta1/Planta2/pradera1.png' },
        { type: 'Pradera', img: 'https://raw.githubusercontent.com/ManuelVS8/Audios-juegos-SCIENCE/refs/heads/main/Planta1/Planta2/pradera2.png' },
        { type: 'Pradera', img: 'https://raw.githubusercontent.com/ManuelVS8/Audios-juegos-SCIENCE/refs/heads/main/Planta1/Planta2/pradera3.png' }
    ];

    // --- FUNCIONES UTILITARIAS ---

    function unlockAudio() { 
        if(audioUnlocked) return; 
        const c=new(window.AudioContext||window.webkitAudioContext)(); 
        const o=c.createOscillator(); 
        const g=c.createGain(); 
        o.connect(g); 
        g.connect(c.destination); 
        g.gain.value=0.0001; 
        o.start(); 
        o.stop(c.currentTime+0.01); 
        audioUnlocked=true; 
    }

    function playSnd(t) { 
        if(!isMuted && audioObjs[t]) { 
            audioObjs[t].currentTime=0; 
            audioObjs[t].play(); 
        } 
    }

    function playTaskAudio(url, delay=500) {
        if(isMuted) return;
        if(audioTimeout) clearTimeout(audioTimeout);
        if(currentAudio) { currentAudio.pause(); currentAudio.currentTime=0; }
        
        audioTimeout = setTimeout(() => { 
            currentAudio = new Audio(url); 
            currentAudio.play(); 
        }, delay);
    }

    function showScreen(id) { 
        document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); 
        document.getElementById(id).classList.add('active'); 
    }

    function updateTimer() {
        const d = (Date.now() - startTime)/1000; 
        elapsed = d;
        const m = Math.floor(d/60).toString().padStart(2,'0'); 
        const s = Math.floor(d%60).toString().padStart(2,'0'); 
        const ms = Math.round((d%1)*10);
        const timeStr = `${m}:${s}.${ms}`;
        
        document.getElementById('globalTimer').textContent = timeStr;
        const t2 = document.getElementById('globalTimer2');
        const t3 = document.getElementById('globalTimer3');
        if(t2) t2.textContent = timeStr;
        if(t3) t3.textContent = timeStr;
    }

    function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    // --- L√ìGICA JUEGO 1 ---

    function initGame1() {
        hits1 = 0; idx1 = 0;
        q1 = shuffle([...game1Data]);
        
        if(!timerInterval) { 
            startTime = Date.now(); 
            timerInterval = setInterval(updateTimer, 100); 
        }
        
        const buttons = document.querySelectorAll('#game1Screen .btn-answer');
        buttons.forEach(btn => {
            btn.onclick = (e) => handleAnswer1(e.target.dataset.type, e.target);
        });

        renderQ1();
    }

    function renderQ1() {
        if(idx1 >= q1.length) {
            setTimeout(initGame2, 600);
            return;
        }
        const item = q1[idx1];
        document.getElementById('gameImg1').src = item.img;
        document.getElementById('progressFill1').style.width = ((idx1/q1.length)*100)+'%';
        document.getElementById('level1').textContent = `Nivel ${idx1+1}/9`;
        
        resetButtons('game1Screen');
    }

    function handleAnswer1(answer, btnElement) {
        const correct = q1[idx1].type;
        checkAnswer(answer, correct, btnElement, 'game1Screen', () => {
            if(answer === correct) hits1++;
            idx1++;
            renderQ1();
        });
    }

    // --- L√ìGICA JUEGO 2 ---

    function initGame2() {
        showScreen('game2Screen');
        hits2 = 0; idx2 = 0;
        q2 = shuffle([...game2Data]);
        
        const buttons = document.querySelectorAll('#game2Screen .btn-answer');
        buttons.forEach(btn => {
            btn.onclick = (e) => handleAnswer2(e.target.dataset.type, e.target);
        });

        document.getElementById('playCardBtn2').onclick = () => playTaskAudio(q2[idx2].audio, 0);

        renderQ2();
    }

    function renderQ2() {
        if(idx2 >= q2.length) {
            setTimeout(initGame3, 600);
            return;
        }
        const item = q2[idx2];
        document.getElementById('cardText2').textContent = item.text;
        document.getElementById('progressFill2').style.width = ((idx2/q2.length)*100)+'%';
        document.getElementById('level2').textContent = `Nivel ${idx2+1}/9`;
        
        resetButtons('game2Screen');
        playTaskAudio(item.audio);
    }

    function handleAnswer2(answer, btnElement) {
        const correct = q2[idx2].type;
        checkAnswer(answer, correct, btnElement, 'game2Screen', () => {
            if(answer === correct) hits2++;
            idx2++;
            renderQ2();
        });
    }

    // --- L√ìGICA JUEGO 3 ---

    function initGame3() {
        showScreen('game3Screen');
        hits3 = 0; idx3 = 0;
        q3 = shuffle([...game3Data]);
        
        const buttons = document.querySelectorAll('#game3Screen .btn-answer');
        buttons.forEach(btn => {
            btn.onclick = (e) => handleAnswer3(e.target.dataset.type, e.target);
        });

        renderQ3();
    }

    function renderQ3() {
        if(idx3 >= q3.length) {
            finish();
            return;
        }
        const item = q3[idx3];
        document.getElementById('gameImg3').src = item.img;
        document.getElementById('progressFill3').style.width = ((idx3/q3.length)*100)+'%';
        document.getElementById('level3').textContent = `Nivel ${idx3+1}/9`;
        
        resetButtons('game3Screen');
    }

    function handleAnswer3(answer, btnElement) {
        const correct = q3[idx3].type;
        checkAnswer(answer, correct, btnElement, 'game3Screen', () => {
            if(answer === correct) hits3++;
            idx3++;
            renderQ3();
        });
    }

    // --- MEC√ÅNICA DE RESPUESTA ---

    function resetButtons(screenId) {
        const buttons = document.querySelectorAll(`#${screenId} .btn-answer`);
        buttons.forEach(btn => {
            btn.classList.remove('highlight-correct', 'highlight-wrong');
            btn.disabled = false;
        });
    }

    function checkAnswer(answer, correct, btnElement, screenId, callback) {
        const buttons = document.querySelectorAll(`#${screenId} .btn-answer`);
        buttons.forEach(b => b.disabled = true);

        if(answer === correct) {
            btnElement.classList.add('highlight-correct');
            playSnd('correct');
            setTimeout(() => {
                callback();
            }, 600);
        } else {
            btnElement.classList.add('highlight-wrong');
            const container = document.getElementById('mainContainer');
            container.classList.add('shake');
            
            buttons.forEach(b => {
                if(b.dataset.type === correct) {
                    b.classList.add('highlight-correct');
                }
            });

            playSnd('error');

            setTimeout(() => {
                container.classList.remove('shake');
                callback();
            }, 1000);
        }
    }

    // --- FINAL ---

    function finish() {
        clearInterval(timerInterval);
        
        const totalQuestions = q1.length + q2.length + q3.length;
        const totalHits = hits1 + hits2 + hits3;
        
        const score = Math.round((((hits1/q1.length)+(hits2/q2.length)+(hits3/q3.length))/3)*100);

        document.getElementById('finalScore').textContent = score;
        document.getElementById('finalTime').textContent = document.getElementById('globalTimer').textContent;
        
        const trophy = document.getElementById('trophyBox');
        const msg = document.getElementById('finalMsg');

        if(score >= 100) { 
            trophy.style.display='block'; 
            msg.textContent='¬°Enhorabuena, puntuaci√≥n m√°xima!'; 
            playSnd('victory'); 
            createConfetti(); 
        } else { 
            trophy.style.display='none'; 
            msg.textContent='¬°Buen trabajo! Sigue practicando'; 
            playSnd('completed'); 
        }
        
        showScreen('finalScreen');
    }

    function createConfetti() {
        for(let i=0;i<100;i++){
            setTimeout(()=>{
                const c = document.createElement('div');
                c.className = 'confetti';
                const x = Math.random() * window.innerWidth;
                const tx = (Math.random() - 0.5) * 200;
                c.style.left = x + 'px';
                c.style.top = '-10px';
                c.style.backgroundColor = ['#ff595e','#1982c4','#6a4c93','#ffca3a','#8ac926'][Math.floor(Math.random()*5)];
                c.style.setProperty('--tx', tx + 'px');
                c.style.setProperty('--ty', window.innerHeight + 20 + 'px');
                document.body.appendChild(c);
                setTimeout(() => c.remove(), 3000);
            }, i * 20);
        }
    }

    // --- EVENTOS INICIALES ---

    document.getElementById('playBtn').onclick = () => { 
        unlockAudio(); 
        playSnd('tap'); 
        showScreen('game1Screen'); 
        initGame1(); 
    };
    
    document.getElementById('backToMenuBtn').onclick = () => { 
        playSnd('tap'); 
        location.reload(); 
    };
    
    document.getElementById('muteBtn').onclick = () => { 
        isMuted = !isMuted; 
        document.getElementById('muteBtn').textContent = isMuted?'üîá':'üîä'; 
        if(currentAudio) currentAudio.pause(); 
    };

</script>
</body>
</html>
